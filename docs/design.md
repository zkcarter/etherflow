
# EtherFlow 项目设计文档

## 1. 项目概述

EtherFlow 是一个基于 TypeScript 开发的 Web 应用，旨在提供一个直观、灵活的界面，使用户能够轻松与任何 EVM 兼容链上的智能合约进行交互。该应用支持多种钱包连接、智能合约 ABI 解析、动态界面生成以及本地存储功能，为开发者和用户提供无缝的智能合约交互体验。

## 2. 技术栈

- **前端框架**：React.js + TypeScript
- **状态管理**：React Context API / Redux Toolkit
- **钱包连接**：wagmi (主推) + ethers.js
- **合约交互**：ethers.js
- **UI 组件库**：Tailwind CSS + shadcn/ui
- **本地存储**：IndexedDB / localStorage
- **构建工具**：Vite
- **开发环境**：Hardhat (用于本地测试)
- **节点服务**：Infura / Alchemy

## 3. 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      EtherFlow Application                       │
├─────────────┬─────────────────────────┬─────────────┬───────────┤
│             │                         │             │           │
│  Wallet     │  Contract               │  Network    │  Storage  │
│  Module     │  Interaction            │  Module     │  Module   │
│  (wagmi)    │  Module                 │             │           │
│             │                         │             │           │
└─────────────┴─────────────────────────┴─────────────┴───────────┘
      ▲                 ▲                      ▲            ▲
      │                 │                      │            │
      ▼                 ▼                      ▼            ▼
┌─────────────┐ ┌─────────────────────┐ ┌─────────────┐ ┌─────────┐
│ Wallet      │ │ Blockchain Networks │ │ RPC         │ │ Browser │
│ Providers   │ │ (EVM Compatible)    │ │ Providers   │ │ Storage │
└─────────────┘ └─────────────────────┘ └─────────────┘ └─────────┘
```

## 4. 核心功能详细设计

### 4.1 钱包连接模块

#### 功能描述
- 支持多种主流钱包连接，包括 MetaMask、OK Wallet 等
- 动态识别用户安装的钱包插件并提供连接选项
- 支持显示当前连接状态、账户地址和余额
- 支持钱包切换和断开连接

#### 实现方案
- 使用 wagmi 库实现钱包连接功能
- 利用 wagmi 提供的 hooks (`useConnect`, `useAccount`, `useNetwork` 等) 处理账户状态和网络变更
- 实现对各种流行钱包的连接器配置
- 设计钱包连接状态管理，处理连接/断开/切换等事件

### 4.2 节点服务与网络配置模块

#### 功能描述
- 支持配置多种 RPC 提供商 (Infura, Alchemy 等)
- 管理不同 EVM 链的网络配置
- 处理网络切换和检测

#### 实现方案
- 使用 wagmi 的 `configureChains` 配置多链支持
- 维护一个网络配置清单，包含链 ID、名称、RPC URL 等
- 实现网络自动检测和手动切换功能
- 处理网络不可用或切换失败的错误情况

### 4.3 合约交互模块

#### 功能描述
- 支持输入合约地址、粘贴 JSON 格式的 ABI 或上传 ABI 文件
- 支持为每个合约设置自定义名称
- 验证合约地址有效性（检查是否为合约而非 EOA 地址）
- 根据 ABI 动态生成合约接口列表
- 支持接口搜索和过滤
- 根据接口参数类型动态生成输入表单
- 清晰区分读操作和写操作
- 实时显示交易状态和结果
- 提供 Gas 费用估算

#### 实现方案
- 使用 ethers.js 解析 ABI 并生成合约接口
- 实现合约地址验证逻辑 (使用 `eth_getCode` 调用)
- 设计动态表单组件，根据参数类型生成相应的输入控件
- 针对数组、结构体等复杂类型设计特殊的输入组件
- 将接口直接分为读操作和写操作两类显示，而非使用下拉菜单
- 实现读写操作的不同处理逻辑
- 集成 Gas 估算功能，允许用户调整 Gas 设置
- 提供交易监控功能，显示交易状态和确认数

### 4.4 交易监控与调试模块

#### 功能描述
- 跟踪交易执行状态
- 提供交易详情查看
- 支持交易失败分析和调试

#### 实现方案
- 使用 ethers.js 的事件监听功能跟踪交易状态
- 设计交易历史记录组件
- 实现交易详情展示，包括 Gas 使用、区块确认等信息
- 解析交易失败原因，提供用户友好的错误提示

### 4.5 合约管理与存储模块

#### 功能描述
- 存储合约配置，包括合约地址、ABI和自定义名称
- 支持浏览、选择、重命名和删除已保存的合约
- 支持合约列表的显示和管理
- 支持导入/导出合约配置功能

#### 实现方案
- 使用 IndexedDB 实现本地存储 (相比 localStorage 支持更大存储容量)
- 设计合约配置数据结构，以唯一ID为主键，包含名称、地址、ABI等字段
- 实现合约配置的增删改查功能
- 提供配置导入/导出功能
- 维护合约列表状态，支持实时更新

## 5. 多链支持设计

### 5.1 支持的网络类型
- 以太坊主网和测试网
- 其他 EVM 兼容链 (Polygon, BSC, Arbitrum, Optimism 等)
- 自定义 EVM 网络

### 5.2 多链实现方案
- 使用 wagmi 的 `configureChains` 预配置常用链
- 设计链配置管理接口，允许添加自定义 RPC URL
- 实现链切换逻辑，处理不同链的特性差异
- 针对不同链优化 Gas 估算逻辑

### 5.3 网络与合约分离设计
- 合约配置不再与网络信息绑定
- 用户可以在任何网络上使用已保存的合约配置
- 系统会检测当前网络是否适用于选中的合约

## 6. UI 组件设计 [更新]

### 6.1 主要页面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 顶部导航栏 (Logo, 钱包连接按钮, 网络选择器)                       │
├───────────────────┬───────────────────────────────────────────────┤
│                   │                                               │
│  可收缩侧边导航栏  │                                               │
│                   │                                               │
│  - 合约列表        │                                               │
│    * 合约名称1     │                                               │
│    * 合约名称2     │               主内容区                         │
│    * ...          │                                               │
│                   │  - 合约地址显示                                │
│                  │  - 合约名称显示                                │
│                   │  - ABI 信息                                    │
│                   │  - 接口列表 (读操作/写操作分区)                 │
│                   │  - 接口详情与参数输入                           │
│  + 新增合约按钮    │  - 交易状态与结果                              │
│                   │                                               │
└───────────────────┴───────────────────────────────────────────────┘
```

### 6.2 核心组件

1. **钱包连接组件**
   - 钱包连接按钮
   - 账户信息显示
   - 网络选择器
   - 切换账户功能

2. **合约导航组件** [新增]
   - 可收缩侧边栏
   - 合约列表显示，支持合约名称定制
   - 合约项操作（删除、重命名）
   - 新增合约按钮

3. **合约表单组件** [更新]
   - 合约地址输入框
   - 合约名称输入框 [新增]
   - ABI 文本域/文件上传区
   - 验证按钮
   - 合约状态指示器

4. **合约详情组件** [新增]
   - 合约地址显示
   - 合约名称显示
   - ABI 摘要信息

5. **接口列表组件** [更新]
   - 直接区分读操作和写操作两个部分
   - 搜索/过滤功能
   - 接口选择功能
   - 接口文档展示

6. **参数输入组件**
   - 动态参数表单
   - 参数验证
   - 类型提示
   - 提交按钮

7. **交易组件**
   - Gas 设置界面
   - 交易确认模态框
   - 交易状态跟踪
   - 交易结果显示

8. **结果显示组件**
   - 读操作结果展示
   - 交易状态和哈希显示
   - 数据格式化展示
   - 错误信息展示

## 7. 数据流 [更新]

### 7.1 钱包连接流程

```
用户 → 选择钱包 → 钱包授权 → 获取账户和网络信息 → 更新应用状态
```

### 7.2 合约添加流程 [更新]

```
点击"新增合约" → 输入合约名称、地址和ABI → 验证合约 → 保存合约信息 → 
更新侧边栏合约列表 → 显示合约详情
```

### 7.3 合约选择流程 [新增]

```
从侧边栏选择合约 → 加载合约信息 → 解析ABI → 生成接口列表 → 
显示合约详情和接口
```

### 7.4 接口交互流程 [更新]

```
选择接口 → 输入参数 → 估算Gas(写操作) → 调用合约 → 
显示结果/交易状态 → 监控交易确认
```

## 8. 数据模型 [更新]

### 8.1 合约配置模型

```typescript
interface ContractConfig {
  id: string;            // 唯一标识符
  name: string;          // 自定义合约名称
  address: string;       // 合约地址
  abi: string;           // ABI JSON字符串
  createdAt: number;     // 创建时间戳
  updatedAt: number;     // 更新时间戳
}
```

### 8.2 接口函数模型

```typescript
interface ContractFunction {
  name: string;          // 函数名称
  type: 'read' | 'write'; // 函数类型
  inputs: FunctionInput[]; // 输入参数
  outputs?: FunctionOutput[]; // 输出参数(读操作)
  stateMutability: string; // 状态可变性
  signature: string;     // 函数签名
}

interface FunctionInput {
  name: string;          // 参数名称
  type: string;          // 参数类型
  components?: FunctionInput[]; // 复合类型组件
}

interface FunctionOutput {
  name: string;          // 输出名称
  type: string;          // 输出类型
  components?: FunctionOutput[]; // 复合类型组件
}
```

## 9. 开发与测试环境

### 9.1 本地开发环境
- 使用 Hardhat 搭建本地开发环境
- 配置测试网络和测试账户
- 部署测试合约进行交互测试

### 9.2 测试策略
- 单元测试：使用 Jest 测试独立组件
- 集成测试：测试模块间交互
- E2E测试：使用 Cypress 测试完整用户流程
- 多浏览器测试：确保跨浏览器兼容性

## 10. 实现路线图

### 阶段一：基础架构设计与开发环境搭建 (周 1-2)
- 项目初始化与依赖安装
- 技术栈整合
- 基础组件设计
- 设置 Hardhat 开发环境

### 阶段二：钱包连接与网络模块实现 (周 3-4)
- 集成 wagmi 库
- 实现多钱包支持
- 实现网络配置与切换
- 建立 RPC 提供商连接

### 阶段三：合约导航与管理功能实现 [更新] (周 4-6)
- 设计侧边导航栏
- 实现合约列表管理
- 实现合约新增、重命名和删除功能
- 开发合约详情页面

### 阶段四：合约交互核心功能实现 (周 6-8)
- ABI 解析与验证
- 接口生成与展示
- 参数表单组件
- 读写操作实现

### 阶段五：交易处理与监控实现 (周 9-10)
- Gas 估算功能
- 交易状态跟踪
- 错误处理与展示
- 交易历史记录

### 阶段六：存储功能实现 [更新] (周 11-12)
- IndexedDB 集成
- 合约配置管理
- 导入/导出功能
- 用户配置保存

### 阶段七：UI 优化与测试 (周 13-14)
- 响应式设计优化
- 用户体验改进
- 跨浏览器兼容性测试
- 性能优化

### 阶段八：文档与部署 (周 15)
- 用户文档编写
- 部署优化
- 发布上线

## 11. 技术挑战与解决方案

### 11.1 多钱包适配
**挑战**：不同钱包提供的 API 和行为可能有差异
**解决方案**：
- 利用 wagmi 提供的标准化钱包连接器
- 实现钱包特性检测，根据可用功能调整 UI
- 为常见错误提供明确的用户指导

### 11.2 复杂参数类型处理
**挑战**：处理数组、嵌套结构等复杂参数类型的输入
**解决方案**：
- 设计专门的复杂类型输入组件
- 实现 JSON 输入支持
- 提供类型提示和验证
- 支持数组元素的动态添加/删除

### 11.3 跨链兼容性
**挑战**：不同 EVM 链之间存在细微差异
**解决方案**：
- 维护链特定配置
- 为特殊链实现自定义逻辑
- 提供链特定的错误处理
- 测试主要 EVM 链的兼容性

### 11.4 大型 ABI 处理
**挑战**：处理包含大量函数的复杂 ABI
**解决方案**：
- 实现高效的 ABI 解析和缓存
- 设计良好的函数分类和搜索功能
- 使用虚拟滚动优化长列表性能
- 提供 ABI 导航功能

### 11.5 合约导航与状态管理 [新增]
**挑战**：管理多个合约的状态和切换
**解决方案**：
- 实现高效的状态管理策略
- 设计合约上下文，处理活跃合约切换
- 缓存已加载的合约数据
- 优化重新渲染性能

## 12. 安全与隐私考虑

- 所有数据存储在本地，不上传到任何服务器
- 明确提示用户交易风险
- 交易前显示参数确认和 Gas 费用
- 防止 XSS 和注入攻击
- 处理钱包错误和异常情况
- 实现敏感数据的安全存储

## 13. 扩展性考虑

- 支持批量交易
- 添加合约事件监听功能
- 集成合约源代码验证
- 支持合约部署功能
- 添加交易模拟功能
- 支持合约函数调用历史记录
- 集成区块浏览器链接与 API
- 支持合约导入/导出和分享功能
